#!/bin/bash

# QuadChat - Start the local AI testing lab
# Usage: quadchat [--port PORT]

# Get the real script directory (works with symlinks on macOS)
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

BACKEND_DIR="$SCRIPT_DIR/quadchat_app/backend"
VENV_DIR="$BACKEND_DIR/venv"
PORT="${PORT:-8001}"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --port|-p)
            PORT="$2"
            shift 2
            ;;
        --help|-h)
            echo "QuadChat - AI Testing Lab"
            echo ""
            echo "Usage: quadchat [options]"
            echo ""
            echo "Options:"
            echo "  -p, --port PORT   Set the port (default: 8001)"
            echo "  -h, --help        Show this help message"
            echo ""
            echo "After starting, open http://localhost:\$PORT in your browser"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Check if virtual environment exists, create if not
if [ ! -d "$VENV_DIR" ]; then
    echo "Setting up QuadChat for first run..."
    python3 -m venv "$VENV_DIR"
    "$VENV_DIR/bin/pip" install --upgrade pip --quiet
    "$VENV_DIR/bin/pip" install -r "$BACKEND_DIR/requirements.txt" --quiet
    echo "Setup complete."
fi

# Check for .env file
if [ ! -f "$BACKEND_DIR/.env" ]; then
    echo ""
    echo "No API keys configured. Create $BACKEND_DIR/.env with your keys:"
    echo ""
    echo "  OPENAI_API_KEY=sk-..."
    echo "  ANTHROPIC_API_KEY=sk-ant-..."
    echo "  GOOGLE_API_KEY=AIza..."
    echo "  XAI_API_KEY=xai-..."
    echo ""
fi

echo ""
echo "  QuadChat starting on http://localhost:$PORT"
echo "  Press Ctrl+C to stop"
echo ""

# Open browser after short delay
(sleep 1.5 && open "http://localhost:$PORT" 2>/dev/null || xdg-open "http://localhost:$PORT" 2>/dev/null) &

# Start the server using the venv's uvicorn directly
cd "$BACKEND_DIR"
exec "$VENV_DIR/bin/uvicorn" server:app --host 0.0.0.0 --port "$PORT"
